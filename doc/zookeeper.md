# zookeeper

## 部署

### 运用场景

### 为什么要奇数台

### 如何选出leader

zxid(事务id,写操作会产生事务id),事务id一样，选取myid最大的，不允许一样的myid，投票会把zxid和myid当参数投票出去，开始会投给自己，发现比自己大以后投给别人，过半数选出leader

### 节点类型（持久，暂时）

### 节点四种类型

### 监听一次只能有效一次吗

### stat

### 监听原理

### 写数据原理

### 持久化

日志+拍照

### zab协议

+ 领导
+ 过半机制
+ 2pc
+ 数据同步

分布式协调工具

## 作用

+ HA master slaver
+ 分布式元数据管理
+ 分布式协调工具

## 谁用

kafka,hdfs,hbase

## 为满足分布式系统有那些特点

+ 集群部署
+ 高可用
+ 顺序性
+ 原子性
+ 数据一致性
+ 实时性

## 选举

### 概念

+ ServerId : 服务id

  ​	数越大权重越大

+ Zxid : 数据Id

  ​	数越大权重越大

+ epoch 逻辑时钟

  投票次数，同一轮投票值相同，每一次都增加，然后接受其他再做比较

+ Server状态：选举状态

  - LOOKING，竞选状态。
  - FOLLOWING，随从状态，同步leader状态，参与投票。
  - OBSERVING，观察状态,同步leader状态，不参与投票。
  - LEADING，领导者状态。

### 判断胜出

 过半选举

### 角色

+ leader
+ follower
+ Observer

### 选举流程

#### 全无数据

+ A启动，投自己一票，然后为looking（选举状态）
+ B启动，投自己一票，然后收到A投票，自己比A大，A改投B,单不过半
+ C启动，投自己一票，然后收到A,B投票，自己比A,B大，A,B改投B,过半选举
+ D启动，投自己一票，自己比A,B,C大，但C已经当选所以自己是小弟
+ E同上

### 详细流程

+ 每一个server 投自己一票开始 选票内容包括服务id,数据id,选举时钟，时钟随轮数增加

## 长链接

+ tcp 长连接
+ 定时心跳

## 节点

+ 树状结构 znode
+ 分为持久节点和临时节点，临时节点断开就消失
+ 顺序节点

## Watcher监听

+ 客户端对znode内容监听，znode有变化就基于tcp长连接通过回调通知给客户端

## Zab 原子广播协议

 保存数据一致性

角色划分，过半写机制，2pc(二阶段提交)